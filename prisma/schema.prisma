// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  PROPERTY_MANAGER
  PROPERTY_OWNER
}

enum PropertyStatus {
  AVAILABLE
  RESERVED
  RENTED
}

enum PaymentFrequency {
  MONTHLY
  QUARTERLY
  SEMI_ANNUALLY
  ANNUALLY
}

enum MaintenanceStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model User {
  id                String             @id @default(uuid())
  email             String             @unique
  password          String
  firstName         String
  lastName          String
  phone             String
  nationalId        String             @unique
  role              UserRole
  isBlocked         Boolean            @default(false)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  // Relations
  subscription      UserSubscription?
  properties        Property[]         @relation("PropertyOwner")
  managedProperties Property[]         @relation("PropertyManager")
  managedEstates    Estate[]           @relation("EstateManager")
  managedTenants    Tenant[]           @relation("TenantManager")
  managedContracts  Contract[]         @relation("ContractManager")
  auditLogs         AuditLog[]

  @@index([email])
  @@index([nationalId])
}

model SubscriptionPlan {
  id                String             @id @default(uuid())
  name              String
  description       String?
  price             Float
  durationDays      Int
  maxProperties     Int                @default(10)
  features          Json?
  isActive          Boolean            @default(true)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  // Relations
  subscriptions     UserSubscription[]
}

model UserSubscription {
  id                String             @id @default(uuid())
  userId            String             @unique
  planId            String
  startDate         DateTime
  endDate           DateTime
  isActive          Boolean            @default(true)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  // Relations
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan              SubscriptionPlan   @relation(fields: [planId], references: [id])

  @@index([userId])
  @@index([planId])
}

model Estate {
  id                String             @id @default(uuid())
  managerId         String?
  name              String
  description       String?
  region            String
  city              String
  street            String
  address           String
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  // Relations
  manager           User?              @relation("EstateManager", fields: [managerId], references: [id])
  properties        Property[]

  @@index([managerId])
}

model Property {
  id                String             @id @default(uuid())
  estateId          String?
  ownerId           String?
  managerId         String?
  name              String
  description       String?
  type              String
  bedrooms          Int?
  bathrooms         Int?
  area              Float?
  floor             Int?
  imageUrl          String?
  status            PropertyStatus     @default(AVAILABLE)
  // Location fields (used when property is standalone without parent estate)
  region            String?
  city              String?
  district          String?
  street            String?
  buildingNumber    String?
  zipCode           String?
  latitude          Float?
  longitude         Float?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  // Relations
  estate            Estate?            @relation(fields: [estateId], references: [id])
  owner             User?              @relation("PropertyOwner", fields: [ownerId], references: [id])
  manager           User?              @relation("PropertyManager", fields: [managerId], references: [id])
  contracts         Contract[]

  @@index([estateId])
  @@index([ownerId])
  @@index([managerId])
  @@index([status])
}

model Tenant {
  id                String             @id @default(uuid())
  managerId         String?
  firstName         String
  lastName          String
  email             String
  phone             String
  nationalId        String             @unique
  birthDate         DateTime
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  // Relations
  manager           User?              @relation("TenantManager", fields: [managerId], references: [id])
  contracts         Contract[]
  maintenanceRequests MaintenanceRequest[]

  @@index([managerId])
  @@index([nationalId])
  @@index([email])
}

model Contract {
  id                String             @id @default(uuid())
  propertyId        String
  tenantId          String
  managerId         String?
  price             Float
  startDate         DateTime
  endDate           DateTime
  paymentFrequency  PaymentFrequency
  documentUrl       String?
  tenantPortalToken String?            @unique
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  // Relations
  property          Property           @relation(fields: [propertyId], references: [id])
  tenant            Tenant             @relation(fields: [tenantId], references: [id])
  manager           User?              @relation("ContractManager", fields: [managerId], references: [id])
  maintenanceRequests MaintenanceRequest[]

  @@index([propertyId])
  @@index([tenantId])
  @@index([managerId])
  @@index([tenantPortalToken])
}

model MaintenanceRequest {
  id                String             @id @default(uuid())
  contractId        String
  tenantId          String
  title             String
  description       String
  status            MaintenanceStatus  @default(PENDING)
  images            Json?              // Array of image URLs
  internalNotes     String?            // Notes from property manager/admin
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  // Relations
  contract          Contract           @relation(fields: [contractId], references: [id])
  tenant            Tenant             @relation(fields: [tenantId], references: [id])

  @@index([contractId])
  @@index([tenantId])
  @@index([status])
}

model AuditLog {
  id                String             @id @default(uuid())
  userId            String?
  action            String
  entity            String
  entityId          String?
  details           Json?
  ipAddress         String?
  createdAt         DateTime           @default(now())

  // Relations
  user              User?              @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([entity])
  @@index([createdAt])
}

model Settings {
  id                String             @id @default(uuid())
  key               String             @unique
  value             Json
  description       String?
  isPublic          Boolean            @default(false)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  @@index([key])
}
